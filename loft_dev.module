<?php
/**
 * @file
 * Base module file for loft_dev
 */

use AKlump\LoftLib\Bash\Bash;
use Drupal\loft_dev\ButtonCatalog;

/**
 * The default interval for ld export
 *
 * 0 = disabled
 */
define('LOFT_DEV_LOFT_DEPLOY_EXPORT_PERIOD_MIN', 0);

/**
 * Tests for a GET var
 *
 * @param string $key The $_GET var key.
 * @param bool $default The default when the $GET var is not present
 *
 * @return bool
 *   TRUE $_GET[$key] is set and not === 0
 *   FALSE $_GET[$key] not present or equals 0
 */
function _loft_dev_check_get_var($key, $default = FALSE) {
  if (!isset($_GET[$key])) {
    return $default;
  }

  return (is_numeric($_GET[$key]) && $_GET[$key] * 1 === 0) ? FALSE : TRUE;
}

/**
 * Implements hook_help().
 *
 * http://api.drupal.org/api/function/hook_help
 *
 * @param string $path
 *   The router menu path, as defined in hook_menu(), for the help that is
 *   being requested; e.g., 'admin/node' or 'user/edit'. If the router path
 *   includes a % wildcard, then this will appear in $path; for example, node
 *   pages would have $path equal to 'node/%' or 'node/%/view'. Your hook
 *   implementation may also be called with special descriptors after a "#"
 *   sign.
 * @param array $arg
 *   An array that corresponds to the return value of the arg() function, for
 *   modules that want to provide help that is specific to certain values of
 *   wildcards in $path. For example, you could provide help for the path
 *   'user/1' by looking for the path 'user/%' and $arg[1] == '1'. This array
 *   should always be used rather than directly invoking arg(), because your
 *   hook implementation may be called for other purposes besides building the
 *   current page's help. Note that depending on which module is invoking
 *   hook_help, $arg may contain only empty strings. Regardless, $arg[0] to
 *   $arg[11] will always be set.
 */
function loft_dev_help($path, $arg) {
  $output = '';
  switch ($path) {
    case 'admin/loft-dev/theme':
    case 'admin/loft-dev/theme/admin':
    case 'loft-dev/theme':
    case 'loft-dev/theme/admin':
      $output .= 'Help area text ' . _loft_dev_dummy_string(24);

      return $output;
  }
}

/**
 * Include (or return include path to) a loft_dev include file(s)
 *
 * @code
 *   'file' => loft_dev_include('pages', 2),
 * @endcode
 *
 * @param... string
 *   Any number of include file keys to include
 *   For includes/loft_dev.example.inc, set this to: example
 * @param int $action
 *   The final argument, if numeric is one of.  If omitted 1 is the default.
 *   1: include the module(s)
 *   2: return the path relative to the module, e.g., hook_menu()
 *   3: return the complete Drupal path per drupal_get_path()
 *   4: return the complete Drupal path to the includes folder, e.g.
 *   hook_views_api() call it like this: loft_dev_include(4),
 *
 * @return string
 *   The path to the FIRST include file requested, but only if $return is set
 *   to TRUE
 */
function loft_dev_include() {
  $includes = func_get_args();
  if (is_numeric(end($includes))) {
    $action = array_pop($includes);
  }
  else {
    $action = 1;
  }
  if ($action > 1) {
    $module = 'includes/loft_dev.' . reset($includes) . '.inc';
    switch ($action) {
      case 3:
        $module = drupal_get_path('module', 'loft_dev') . '/' . $module;
        break;
      case 4:
        $module = drupal_get_path('module', 'loft_dev') . '/includes';
        break;
    }

    return $module;
  }
  reset($includes);
  foreach ($includes as $include_name) {
    module_load_include('inc', 'loft_dev', 'includes/loft_dev.' . $include_name);
  }
}

/**
 * @FIXME
 * This implementation of hook_menu() cannot be automatically converted because
 * it contains logic (i.e., branching statements, function calls, object
 * instantiation, etc.) You will need to convert it manually. Sorry!
 *
 * For more information on how to convert hook_menu() to Drupal 8's new routing
 * and linking systems, see
 *   https://api.drupal.org/api/drupal/core%21includes%21menu.inc/group/menu/8
 */


function loft_dev_menu() {
  $items = [];

  $items['admin/loft-dev'] = [
    'title' => 'Loft Dev',
    'page callback' => 'loft_dev_page',
    'access callback' => '_loft_dev_access',
    'type' => MENU_NORMAL_ITEM,
    'file' => loft_dev_include('pages', 2),
  ];
  $items['admin/loft-dev/migration'] = [
    'title' => 'Migration',
    'page callback' => 'loft_dev_migration_page',
    'access callback' => '_loft_dev_access',
    'type' => MENU_NORMAL_ITEM,
    'file' => loft_dev_include('pages', 2),
  ];
  $items['admin/loft-dev/parse-time'] = [
    'title' => 'Pull Timestamps',
    'description' => 'Parse English Time from a string and convert to Unix',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['loft_dev_parse_time_form'],
    'access callback' => '_loft_dev_access',
    'type' => MENU_NORMAL_ITEM,
    'file' => loft_dev_include('pages', 2),
  ];
  $items['admin/loft-dev/css-aggregation'] = [
    'title' => 'CSS Aggregation',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['loft_dev_css_aggregation_form'],
    'access callback' => '_loft_dev_access',
    'type' => MENU_NORMAL_ITEM,
    'file' => loft_dev_include('pages', 2),
  ];
  $items['admin/loft-dev/overview'] = [
    'title' => 'Overview',
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => -10,
  ];
  $items['admin/loft-dev/zebra'] = [
    'title' => 'Zebra Striping',
    'page callback' => 'loft_dev_zebra_striping_page',
    'access callback' => '_loft_dev_access',
    'type' => MENU_LOCAL_TASK,
    'file' => loft_dev_include('pages', 2),
  ];
  $items['admin/loft-dev/fpo-image'] = [
    'title' => 'FPO Image',
    'page callback' => 'loft_dev_fpo_image_page',
    'access callback' => '_loft_dev_access',
    'type' => MENU_LOCAL_TASK,
    'file' => loft_dev_include('pages', 2),
  ];
  $items['admin/loft-dev/rem'] = [
    'title' => 'REM Font Sizing',
    'page callback' => 'loft_dev_rem_page',
    'access callback' => '_loft_dev_access',
    'type' => MENU_LOCAL_TASK,
    'file' => loft_dev_include('pages', 2),
  ];
  $items['admin/loft-dev/server'] = [
    'title' => 'Server Vars',
    'page callback' => 'loft_dev_server_vars_page',
    'access callback' => TRUE,
    'access callback' => '_loft_dev_access',
    'type' => MENU_LOCAL_TASK,
    'file' => loft_dev_include('pages', 2),
  ];

  $items['admin/loft-dev/list'] = [
    'title' => 'Functions Lists',
    'page callback' => 'loft_dev_list_functions_page',
    'page arguments' => ['functions'],
    'access callback' => '_loft_dev_access',
    'type' => MENU_NORMAL_ITEM,
    'file' => loft_dev_include('pages', 2),
  ];
  $items['admin/loft-dev/list/functions'] = [
    'title' => 'PHP Functions',
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => -10,
  ];
  $items['admin/loft-dev/list/constants'] = [
    'title' => 'PHP Constants',
    'page callback' => 'loft_dev_list_functions_page',
    'page arguments' => [3],
    'access callback' => '_loft_dev_access',
    'type' => MENU_LOCAL_TASK,
    'file' => loft_dev_include('pages', 2),
  ];
  $items['admin/loft-dev/list/classes'] = [
    'title' => 'PHP Classes',
    'page callback' => 'loft_dev_list_functions_page',
    'page arguments' => [3],
    'access callback' => '_loft_dev_access',
    'type' => MENU_LOCAL_TASK,
    'file' => loft_dev_include('pages', 2),
  ];
  $items['admin/loft-dev/list/libraries'] = [
    'title' => 'Drupal Libraries',
    'page callback' => 'loft_dev_list_libraries_page',
    'access callback' => '_loft_dev_access',
    'type' => MENU_LOCAL_TASK,
    'file' => loft_dev_include('pages', 2),
  ];
  $items['admin/loft-dev/list/fapi'] = [
    'title' => 'FAPI Elements',
    'page callback' => 'loft_dev_list_fapi_elements_page',
    'access callback' => '_loft_dev_access',
    'type' => MENU_LOCAL_TASK,
    'file' => loft_dev_include('pages', 2),
  ];
  $items['admin/loft-dev/theme'] = [
    'title' => 'Default Theme Tester',
    'page callback' => 'drupal_goto',
    'page arguments' => ['loft-dev/theme'],
    'access callback' => '_loft_dev_access',
    'type' => MENU_LOCAL_TASK,
    'file' => loft_dev_include('pages', 2),
  ];
  $items['admin/loft-dev/theme/admin'] = [
    'title' => 'Admin theme test page',
    'page callback' => 'loft_dev_theme_test_page',
    'page arguments' => [3],
    'access callback' => '_loft_dev_access',
    'type' => MENU_LOCAL_TASK,
    'file' => loft_dev_include('pages', 2),
  ];
  $items['admin/loft-dev/theme/403'] = [
    'title' => '403 page',
    'page callback' => 'drupal_goto',
    'page arguments' => ['loft-dev/theme/403'],
    'access callback' => '_loft_dev_access',
    'type' => MENU_LOCAL_TASK,
  ];
  $items['admin/loft-dev/theme/404'] = [
    'title' => '404 page',
    'page callback' => 'drupal_goto',
    'page arguments' => ['loft-dev/theme/404'],
    'access callback' => '_loft_dev_access',
    'type' => MENU_LOCAL_TASK,
  ];
  $items['admin/loft-dev/theme/offline'] = [
    'title' => 'Maintenance page',
    'page callback' => 'drupal_goto',
    'page arguments' => ['loft-dev/theme/offline'],
    'access callback' => '_loft_dev_access',
    'type' => MENU_LOCAL_TASK,
  ];

  $items['loft-dev/theme'] = [
    'title' => 'Default theme test page',
    'page callback' => 'loft_dev_theme_test_page',
    'access callback' => '_loft_dev_access',
    'type' => MENU_CALLBACK,
    'file' => loft_dev_include('pages', 2),
  ];
  $items['loft-dev/theme/action1'] = [
    'title' => 'Action Link #1',
    'description' => 'Some description is helpful for UX',
    'page callback' => 'drupal_goto',
    'access callback' => '_loft_dev_access',
    'type' => MENU_LOCAL_ACTION,
  ];
  $items['loft-dev/theme/action2'] = [
    'title' => 'Action Link #2',
    'description' => 'Some description is helpful for UX',
    'page callback' => 'drupal_goto',
    'access callback' => '_loft_dev_access',
    'type' => MENU_LOCAL_ACTION,
  ];
  $items['loft-dev/theme/action3'] = [
    'title' => 'Action Link #3',
    'description' => 'Some description is helpful for UX',
    'page callback' => 'drupal_goto',
    'access callback' => '_loft_dev_access',
    'type' => MENU_LOCAL_ACTION,
  ];
  $items['loft-dev/theme/403'] = [
    'title' => '403 page',
    'page callback' => 'drupal_access_denied',
    'access callback' => '_loft_dev_access',
    'type' => MENU_CALLBACK,
  ];
  $items['loft-dev/theme/404'] = [
    'title' => '404 page',
    'page callback' => 'drupal_not_found_page',
    'access callback' => '_loft_dev_access',
    'type' => MENU_CALLBACK,
    'file' => loft_dev_include('pages', 2),
  ];
  $items['loft-dev/theme/offline'] = [
    'page callback' => 'drupal_site_offline',
    'access callback' => '_loft_dev_access',
    'type' => MENU_CALLBACK,
  ];
  $items['loft-dev/theme/playground'] = [
    'title' => 'Loft Dev Theme Playground',
    'page callback' => 'loft_dev_playground_page',
    'access callback' => '_loft_dev_access',
    'type' => MENU_CALLBACK,
    'file' => loft_dev_include('pages', 2),
  ];
  $items['loft-dev/theme/teasers'] = [
    'page callback' => 'loft_dev_teasers_page',
    'access callback' => '_loft_dev_access',
    'type' => MENU_CALLBACK,
    'file' => loft_dev_include('pages', 2),
  ];

  $url = 'loft-dev/theme/button-catalog';
  $items['admin/' . $url] = [
    'title' => 'Button catalog',
    'page callback' => 'drupal_goto',
    'page arguments' => [$url],
    'access callback' => '_loft_dev_access',
    'type' => MENU_LOCAL_TASK,
  ];
  $items[$url] = [
    'page callback' => 'loft_dev_button_catalog_page',
    'access callback' => '_loft_dev_access',
    'type' => MENU_CALLBACK,
    'file' => loft_dev_include('pages', 2),
  ];

  return $items;
}

/**
 * Implements hook_form_alter().
 */
function loft_dev_form_field_ui_display_overview_form_alter(&$form, &$form_state, $form_id) {

  if (!isset($_GET['reset'])) {
    return;
  }
  $entity_type = $form['#entity_type'];
  $bundle = $form['#bundle'];
  $view_mode = $form['#view_mode'];

  $label = isset($_GET['label']) ? $_GET['label'] : 'above';
  $field_names = array_merge($form['#fields'], $form['#extra'], $form['#groups']);
  foreach ($field_names as $field_name) {

    // if (empty($_GET['no_refresh'])) {
    //   $refresh = FALSE;
    //   $s = field_bundle_settings($entity_type, $bundle);
    //   if (isset($s['extra_fields']['display'])) {
    //     foreach ($s['extra_fields']['display'] as $field_name => &$view_modes) {
    //       if (isset($view_modes[$view_mode])) {
    //         $view_modes[$view_mode]['weight']  = 0;
    //         $view_modes[$view_mode]['visible'] = FALSE;
    //         $refresh = TRUE;
    //       }
    //     }
    //   }

    //   if ($refresh) {
    //     field_bundle_settings($entity_type, $bundle, $s);
    //     $url = $_SERVER['REQUEST_URI'];
    //     $url .= '&no_refresh=TRUE';
    //     header('Location: ' . $url, TRUE, 301);
    //     drupal_exit($url);
    //   }
    // }

    if (isset($form['fields'][$field_name])) {
      $field = &$form['fields'][$field_name];
      $field['weight']['#default_value'] = 0;
      $field['label']['#default_value'] = $label;
      $field['parent_wrapper']['parent']['#default_value'] = NULL;
      $field['format']['type']['#default_value'] = 'hidden';
    }
  }
}


/**
 * Implements hook_form_alter
 */
function loft_dev_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {

  $is_new = (empty($form['old_type']['#value']));

  if ($form_id == 'node_type_form' && $is_new) {

    //modify the node body so it is blank by default
    $form['#node_type']->body_label = '';
    $form['#node_type']->has_body = FALSE;
    $form['submission']['body_label']['#default_value'] = '';

    //turn off comments by default
    $form['comment']['comment']['#default_value'] = 0;

    //turn off promoted to front page default
    unset($form['workflow']['node_options']['#default_value'][1]);

    //expand title fieldset to change the title
    $form['submission']['#collapsed'] = 0;
  }
}

/**
 * Determine if the current user has access to the dev tools
 *
 * @return bool
 */
function _loft_dev_access() {
  return \Drupal::currentUser()
      ->hasPermission('loft_dev:use tools') || \Drupal::config('loft_dev.settings')
      ->get('loft_dev_free_access');
}

/**
 * Implements hook_preprocess_html().
 */
function loft_dev_preprocess_block(&$vars) {
  if (!_loft_dev_access()) {
    return;
  }
  _loft_dev_playground_data('block', $vars);

  global $_loft_dev_playground;
  if ($_loft_dev_playground === TRUE) {
    $vars['theme_hook_suggestion'] = 'block__loft_dev_playground';
  }
}

/**
 * Implements hook_preprocess_html().
 */
function loft_dev_preprocess_html(&$vars) {
  return;
  global $_design_guide;

  if (!_loft_dev_access()) {
    return;
  }

  _loft_dev_playground_data('html', $vars);

  global $_loft_dev_playground;
  if ($_loft_dev_playground === TRUE) {
    $vars['theme_hook_suggestion'] = 'html__loft_dev_playground';
  }

  // Append the loft dev tools to page_bottom
  $build = [];
  $build['loft_dev']['block'] = \Drupal::moduleHandler()
    ->invoke('loft_dev', 'block_view', ['dev_tools']);
  $build['loft_dev']['#prefix'] = '<div class="block-loft-dev">';
  $build['loft_dev']['#suffix'] = '</div>';

  $vars['page']['page_bottom']['loft_dev_block'] = $build;
  if ($_design_guide) {
    // Supporess loft_dev_block on design page.
    $vars['page']['page_bottom']['loft_dev_block']['#access'] = FALSE;
  }
}

/**
 * Implements hook_preprocess_page().
 */
function loft_dev_preprocess_page(&$vars) {
  global $_loft_dev_ignored_url;
  if ($_loft_dev_ignored_url) {
    return;
  }
  if (!_loft_dev_access()) {
    return;
  }

  _loft_dev_playground_data('page', $vars);

  global $_loft_dev_playground;
  if ($_loft_dev_playground === TRUE) {
    $vars['theme_hook_suggestion'] = 'page__loft_dev_playground';
  }
}

/**
 * Set an array element deep inside based on an array of nested keys.
 *
 * @code
 *   $vars   = array();
 *   $string = 'some.string.of.keys';
 *   $tree   = explode('.', $string);
 *   $value  = 'final value';
 *   loft_dev_array_set_nested_element($vars, $tree, $value);
 * @endcode
 *
 * The end result is $vars['some']['string']['of']['keys'] = 'final value';
 *
 * @param array &$array The base array.
 * @param array &$keys An array of keys, each successive a child of the
 *                       former.
 * @param mixed $value The final value to set on the last child key.
 */
function loft_dev_array_set_nested_element(&$array, &$keys, $value) {
  if (!($key = array_shift($keys))) {
    $array = $value;

    return;
  }
  if (!isset($array[$key])) {
    $array[$key] = [];
  }
  $self = __FUNCTION__;

  return $self($array[$key], $keys, $value);
}

/**
 * Loads data from flatfiles for a given scope, e.g., html, page.
 *
 * @param string $scope Expecting html, page, etc.
 * @param array &$vars The vars for that scope.
 */
function _loft_dev_playground_data($scope, &$vars) {
  global $_loft_dev_ignored_url;
  if ($_loft_dev_ignored_url) {
    return;
  }

  $g = data_api();
  $default = \Drupal::config('loft_dev.settings')
    ->get('loft_dev_playground_load_data');
  if (!_loft_dev_check_get_var('ldp_data', $default)) {
    return;
  }
  $info = \Drupal::moduleHandler()->invokeAll('loft_dev_playground_info');
  $data = [];
  foreach (\Drupal::moduleHandler()
             ->getImplementations('loft_dev_playground_info') as $module) {
    if (($info = \Drupal::moduleHandler()
        ->invoke($module, 'loft_dev_playground_info'))
      && file_exists($info['data_path'])
    ) {
      $regex = '/' . preg_quote($scope) . "\.(.+)\.php$/";

      $config_file = $info['data_path'] . '/config.json';
      $config = is_readable($config_file) && ($config = json_decode(file_get_contents($config_file), TRUE)) ? $config : [];

      file_scan_directory($info['data_path'], $regex, [
        'callback' => function ($uri) use ($scope, $regex, &$vars, $config, $g) {

          if (in_array(pathinfo($uri, PATHINFO_BASENAME), $g->get($config, 'ignore', []))) {
            return;
          }

          preg_match($regex, $uri, $matches);
          ob_start();
          require_once \Drupal::root() . '/' . $uri;
          $content = ob_get_contents();
          ob_end_clean();

          if (trim($content)) {
            $content = ['#markup' => $content];
            $tree = explode('.', $matches[1]);
            array_unshift($tree, $scope);
            loft_dev_array_set_nested_element($vars, $tree, $content);
          }
        },
      ], $depth = 0);
    }
  }
}


/**
 * Implements hook_loft_dev_playground_info().
 *
 * Registers the active theme
 */
function loft_dev_loft_dev_playground_info() {
  return [
    'data_path' => \Drupal::theme()
        ->getActiveTheme()
        ->getPath() . '/loft_dev_playground',
  ];
}

/**
 * Implements hook_block_view_alter().
 */
function loft_dev_block_view_alter(&$data, $block) {

  return;
  loft_dev_include('drupal_deploy');
  if (($disk = loft_dev_drupal_deploy_get_block($block->module, $block->delta))) {
    $data = $disk;
  }
  global $_design_guide;
  if ($_design_guide && $block->module == 'loft_dev') {
    $data = NULL;
  }
}

/**
 * Getter/setter for private storage of data
 *
 * This is used so that we bypass the database and store this in the private
 * directory; by doing this we avoid nuking this when we pull from prod.  In
 * essence its a supersceding storage mechanism.
 *
 * @param string $group A key to group related data.
 * @param array $data Keyed by filename, the values will become the file
 *                       contents.
 *
 * @return array  The currently stored values.
 */
function loft_dev_private_storage($group, $data = NULL) {
  $dir = 'private://loft_dev/' . $group;
  try {
    file_prepare_directory($dir, FILE_CREATE_DIRECTORY);
    if (isset($data)) {
      foreach ($data as $filename => $value) {
        file_unmanaged_save_data($value, $dir . '/' . $filename, FILE_EXISTS_REPLACE);
      }
    }
    $data = file_scan_directory($dir, '/.+/', ['key' => 'filename']);
    foreach (array_keys($data) as $filename) {
      $data[$filename] = file_get_contents($dir . '/' . $filename);
    }
  }
  catch (Exception $e) {
    watchdog_exception('loft_dev', $e);
  }

  return $data;
}

/**
 * Implementation of hook_mail
 */
function loft_dev_mail_alter($message) {
  global $_loft_dev_mail_system_stashed_, $_loft_dev_mail_filename_;
  if (\Drupal::config('loft_dev.settings')->get('loft_dev_mail_capture')) {

    // Stashes and sets to the testing mail system.
    // @FIXME
    // // @FIXME
    // // This looks like another module's variable. You'll need to rewrite this call
    // // to ensure that it uses the correct configuration object.
    // $_loft_dev_mail_system_stashed_ = variable_get('mail_system');

    // @FIXME
    // // @FIXME
    // // This looks like another module's variable. You'll need to rewrite this call
    // // to ensure that it uses the correct configuration object.
    // variable_set('mail_system', ['default-system' => 'TestingMailSystem']);


    // Saves a copy of the message in the private files
    $_loft_dev_mail_filename_ = 'private://loft-dev/mail/' . time();
    $url = $_loft_dev_mail_filename_ . '.mail_alter.txt';
    file_prepare_directory(dirname($url), FILE_CREATE_DIRECTORY);
    file_unmanaged_save_data(var_export($message, TRUE), $url);
    // @FIXME
    // // @FIXME
    // // This looks like another module's variable. You'll need to rewrite this call
    // // to ensure that it uses the correct configuration object.
    // variable_set('mail_system', ['default-system' => 'TestingMailSystem']);

  }
}

/**
 * Converts a drupal mail array into a snippet of php code.
 *
 * @param array $message
 *
 * @return string
 *
 * @see  DefaultMailSystem
 */
function _loft_dev_compose_php_mail($message) {
  $to = $message['to'];

  if (isset($message['headers']['Return-Path']) && !ini_get('safe_mode')) {
    $return_path_set = strpos(ini_get('sendmail_path'), ' -f');
    if (!$return_path_set) {
      $message['Return-Path'] = $message['headers']['Return-Path'];
      unset($message['headers']['Return-Path']);
    }
  }
  $mimeheaders = [];
  foreach ($message['headers'] as $name => $value) {
    $mimeheaders[] = $name . ': ' . \Drupal\Component\Utility\Unicode::mimeHeaderEncode($value);
  }
  // @FIXME
  // // @FIXME
  // // This looks like another module's variable. You'll need to rewrite this call
  // // to ensure that it uses the correct configuration object.
  // $line_endings = variable_get('mail_line_endings', MAIL_LINE_ENDINGS);

  // Prepare mail commands.
  $mail_subject = \Drupal\Component\Utility\Unicode::mimeHeaderEncode($message['subject']);
  // Note: e-mail uses CRLF for line-endings. PHP's API requires LF
  // on Unix and CRLF on Windows. Drupal automatically guesses the
  // line-ending format appropriate for your system. If you need to
  // override this, adjust $conf['mail_line_endings'] in settings.php.
  $mail_body = preg_replace('@\r?\n@', $line_endings, $message['body']);
  // For headers, PHP's API suggests that we use CRLF normally,
  // but some MTAs incorrectly replace LF with CRLF. See #234403.
  $mail_headers = join("\n", $mimeheaders);

  $mail_to = addslashes($mail_to);
  $mail_subject = addslashes($mail_subject);
  $mail_body = addslashes($mail_body);
  $mail_headers = addslashes($mail_headers);

  $code = <<<EOD
<?php
\$success   = mail('{$to}', '{$mail_subject}', '{$mail_body}', '{$mail_headers}');

// Feedback to screen.
print \$success ? 'mail() works' : 'mail() failed';
exit();
EOD;

  return $code;
}

/**
 * Implements hook_loft_dev_admin_stuff().
 */
function loft_dev_loft_dev_admin_stuff() {
  return [
    'selectors' => [
      ".block-alter-partials-dev",
      ".contextual-links-trigger",
      ".contextual-links-wrapper",
      ".block-masquerade",
      ".loft-deploy",
      ".loft-dev-closure",
      ".menu.devel",
      "#loft-dev-update-rewind-form",
      ".block-loft-dev",
      "#admin-menu",
      "#toolbar",
      ".dev-query",
      "ul.tabs.primary",
      ".views-field-edit-node",
      ".block-loft-dev-page-review-checklist",
    ],
  ];
}

/**
 * Implements hook_loft_dev_menu
 *
 * Easily add links to the loft dev console
 *
 * @return array
 * This will be passed to theme_links
 * An array of arrays with:
 * - title: the visible link title
 * - href: the link to
 *
 * @see theme_links()
 */
function loft_dev_loft_dev_menu() {
  $links = [
    [
      'title' => t('Hide Admin Stuff'),
      'href' => '#',
      'attributes' => [
        'script' => 'return false;',
        'class' => [
          'loft-dev-closure-hide',
          'loft-dev-hide-admin-trigger',
        ],
      ],
    ],
    [
      'title' => 'Functions',
      'href' => 'admin/loft-dev/list/functions',
    ],
    [
      'title' => 'Constants',
      'href' => 'admin/loft-dev/list/constants',
    ],
    [
      'title' => 'Classes',
      'href' => 'admin/loft-dev/list/classes',
    ],
  ];

  $links[] = [
    'title' => t('List Libraries'),
    'href' => 'admin/loft-dev/list/libraries',
  ];

  return $links;
}

/**
 * Implements hook_flush_caches().
 */
function loft_dev_flush_caches() {
  if (!_loft_dev_access()) {
    return;
  }

  unset($_SESSION['loft_dev']['node_suite']);
}

/**
 * Return an array of nids, random, one of each node type
 */
function loft_dev_node_suite() {
  return [];
  // TODO Fix this.
  if ($cache = \Drupal::cache('cache')->get('loft_dev:node_suite')) {
    $suite = empty($cache->data) ? NULL : $cache->data;
  }
  else {
    // Set the default values
    $suite = [];
    $cache = (object) ['data' => []];
  }
  if (empty($suite)) {

    $types = array_keys(node_type_get_types());
    foreach ($types as $type) {
      $query = db_select('node', 'n');
      $nid = $query
        ->fields('n', ['nid',])
        ->condition('status', 1)
        ->condition('type', $type)
        ->orderRandom()
        ->range(0, 1)
        ->execute()
        ->fetchField();

      // If no published nodes then turn to unpublished
      if (empty($nid)) {
        $query = db_select('node', 'n');
        $nid = $query
          ->fields('n', ['nid',])
          ->condition('status', 0)
          ->condition('type', $type)
          ->orderRandom()
          ->range(0, 1)
          ->execute()
          ->fetchField();
      }
      $suite[$type] = $nid;
    }
    ksort($suite);

    \Drupal::cache('cache')
      ->set('loft_dev:node_suite', $suite, \Drupal\Core\Cache\Cache::PERMANENT);
  }

  return $suite;

  // //use this to clear the above, if needed
  // cache_clear_all('loft_dev:node_suite', 'cache');
}

/**
 * Form builder for the loft_dev_update_rewind form.
 *
 * Generates a form to select a module to rewind it's last update hook
 *
 * @see     loft_dev_update_rewind_form_validate()
 * @see     loft_dev_update_rewind_form_submit()
 * @ingroup forms
 */
function loft_dev_update_rewind_form($form, &$form_state) {
  $form = [];

  $modules = module_list(FALSE, FALSE, TRUE);
  $form['#rollbacks'] = [];
  foreach ($modules as $key => $module_name) {
    $modules[$key] = $module_name;
    // @FIXME
    // // @FIXME
    // // The correct configuration object could not be determined. You'll need to
    // // rewrite this call manually.
    // if (($form['#rollbacks'][$key] = variable_get('loft_dev:update_rollback_' . $module_name, NULL))) {
    //       $modules[$key] .= ':' . $form['#rollbacks'][$key];
    //     }

  }

  $form['module'] = [
    '#type' => 'select',
    '#title' => t('Replay Last Module Update'),
    '#default_value' => !empty($_SESSION['loft_dev']['last_rewind']) ? $_SESSION['loft_dev']['last_rewind'] : '',
    '#options' => $modules,
  ];
  $form['submit'] = [
    '#type' => 'submit',
    '#value' => t('Replay Update'),
  ];

  return $form;
}

/**
 * Form submission handler for loft_dev_update_rewind_form().
 *
 * @see loft_dev_update_rewind_form()
 * @see loft_dev_update_rewind_form_validate()
 */
function loft_dev_update_rewind_form_submit($form, &$form_state) {
  $module = $form_state['values']['module'];
  $version = $form['#rollbacks'][$module];
  $_SESSION['loft_dev']['last_rewind'] = $module;

  // @FIXME
  // $query = db_select('system', 's');


  // If not submitted then we use one before the current.

  if (empty($version)) {
    $version = $query
      ->fields('s', ['schema_version'])
      ->condition('name', $form_state['values']['module'])
      ->execute()->fetchField();
    --$version;
  }

  // @FIXME
  // $count = db_update('system')
  //     ->fields(['schema_version' => $version])
  //     ->condition('name', $form_state['values']['module'])
  //     ->execute();

  if ($count) {
    drupal_set_message(t('%module has been rewound to version %version', [
      '%module' => $form_state['values']['module'],
      '%version' => $version,
    ]));
  }
  $form_state['redirect'] = 'update.php';
}


/**
 * These UTILITY FUNCTIONS can be copied into your module's .install file and
 * used for helping with one off updates; by copying them into your .install
 * file, you will not need to have this module running on production. Be sure to
 * rename the functions to match your module if you go this route.
 */

/**
 * Update helper function to move a block to a new region
 *
 * @param string $module
 * @param string $delta
 * @param string $new_region
 *                     Set to empty() or -1 to disable block
 * @param array or string $themes
 *                     If empty block will be moved for all themes.
 *                     If one theme you may pass a string.
 * @param int $new_weight
 *                     Optional, if you want to assign it a new weight.
 */
function loft_dev_move_block($module, $delta, $new_region, $themes = [], $new_weight = NULL) {
  if (empty($themes)) {
    $themes = array_keys(list_themes(TRUE));
  }
  elseif (is_string($themes)) {
    $themes = [$themes];
  }

  $fields = [
    'region' => empty($new_region) ? -1 : $new_region,
    'status' => empty($new_region) ? 0 : 1,
  ];
  if ($new_weight) {
    $fields['weight'] = $new_weight;
  }

  db_update('block')
    ->fields($fields)
    ->condition('module', $module)
    ->condition('delta', $delta)
    ->condition('theme', $themes, 'IN')
    ->execute();
  cache_clear_all();
}

/**
 * Generate code for placement of all blocks
 *
 * @param string $theme
 *   Optional, will use the block placment for current theme if empty
 * @param array $themes
 *   An array of themes to match these settings
 *
 * @return string
 *   The return code can be added to hook_update_n to control placement of
 *   blocks in regions
 *
 * @code
 *  drush ev "loft_dev_export_block_regions(NULL, array('og2_theme',
 *  'fh_theme'))"
 * @endcode
 */
function loft_dev_export_block_regions($theme = NULL, $themes = []) {
  if (empty($theme)) {
    // @FIXME
    // // @FIXME
    // // This looks like another module's variable. You'll need to rewrite this call
    // // to ensure that it uses the correct configuration object.
    // $theme = variable_get('theme_default', NULL);

  }
  $query = db_select('block', 'b');
  $query
    ->fields('b', ['module', 'delta', 'region'])
    ->condition('theme', $theme)
    ->orderBy('region');
  $export = [];
  $region = NULL;
  foreach ($query->execute() as $data) {
    if ($region != $data->region) {
      $region = $data->region;
      $export[] = NULL;
      $export[] = "  // $region";
    }
    $export[] = "  loft_dev_move_block('" . $data->module . "', '" . $data->delta . "', '" . $data->region . "', array('" . implode("', '", $themes) . "'));";
  }
  print "\n";
  print implode("\n", $export);
  print "\n";

  return;
}

/**
 * @see loft_db_update_block().
 */
function loft_dev_update_block($delta, $block, $module = 'block') {
  if (!\Drupal::moduleHandler()->moduleExists('loft_updb')) {
    \Drupal::logger('loft_dev')->error('Missing module loft_updb', []);

    return;
  }

  return loft_updb_update_block($delta, $block, $module);
}

/**
 * Add a new custom block to the system
 *
 * @param bool $overwrite
 *                            Set this to true to delete a block with a
 *                            matching $description.
 * @param array $body
 *                            - key is the numerical format id
 *                            - value is the body text
 * @param string $description ($block->info)
 * @param array $placement
 *                            - each key is a theme_name
 *                            - each value is an array of regions for that
 *                            theme
 * @param string       title
 *
 * @return int
 *   The delta
 */
function loft_dev_new_block($overwrite, $body, $description, $placement = [], $title = '') {
  $format = key($body);
  $body = current($body);

  if ($overwrite) {
    $old_delta = db_select('block_custom', 'bc')
      ->fields('bc', ['bid',])
      ->condition('info', $description)
      ->execute()
      ->fetchField();
    db_delete('block_custom')
      ->condition('info', $description)
      ->execute();
    db_delete('block')
      ->condition('module', 'block')
      ->condition('delta', $old_delta)
      ->execute();
    //db_delete('block_role')
    //  ->condition('module', 'block')
    //  ->condition('delta', $delta)
    //  ->execute();
  }
  $delta = db_insert('block_custom')
    ->fields([
      'body' => $body,
      'info' => $description,
      'format' => $format,
    ])
    ->execute();

  // This moves the delta in block_role
  // @todo wonky - aklump 11/07/2012 16:55:06
  if ($overwrite) {
    $count = db_update('block_role')
      ->fields(['delta' => $delta])
      ->condition('module', 'block')
      ->condition('delta', $old_delta)
      ->execute();
  }

  $query = db_insert('block')->fields([
    'visibility',
    'pages',
    'custom',
    'title',
    'module',
    'theme',
    'status',
    'weight',
    'delta',
    'cache',
  ]);
  $theme_list = array_keys($placement);
  foreach ($theme_list as $theme_name) {
    $query->values([
      'visibility' => 0,
      'pages' => '',
      'custom' => 0,
      'title' => $title,
      'module' => 'block',
      'theme' => $theme_name,
      'status' => 0,
      'weight' => 0,
      'delta' => $delta,
      'cache' => DRUPAL_NO_CACHE,
    ]);
  }
  $query->execute();

  //$query = db_insert('block_role')->fields(array('rid', 'module', 'delta'));
  //foreach (array_filter($form_state['values']['roles']) as $rid) {
  //  $query->values(array(
  //    'rid' => $rid,
  //    'module' => $form_state['values']['module'],
  //    'delta' => $delta,
  //  ));
  //}
  //$query->execute();

  // Store regions per theme for this block
  if (is_string($regions)) {
    $regions = [$regions];
  }
  foreach ($placement as $theme => $regions) {
    foreach ($regions as $region) {
      db_merge('block')
        ->key([
          'theme' => $theme,
          'delta' => $delta,
          'module' => 'block',
        ])
        ->fields([
          'region' => ($region == BLOCK_REGION_NONE ? '' : $region),
          'pages' => '',
          'status' => (int) ($region != BLOCK_REGION_NONE),
        ])
        ->execute();
    }
  }

  cache_clear_all();

  return $delta;
}

/**
 * Update a node
 *
 * @param int $nid
 * @param string or object
 *                   If object this will be passed directly to node_save
 *                   If a string it will be passed as the body of the node
 *
 * @return bool
 */
function loft_dev_update_node($nid, $body) {
  if (empty($node->nid)) {
    return FALSE;
  }
  $node->save();
}

/**
 * Update helper function to reorder blocks in a region
 *
 * @param string $region
 * @param array $blocks
 *   Each element is 'module|delta'
 *
 * @return bool
 */
function loft_dev_block_order($region, $blocks, $starting_weight = -20) {
  $weight = $starting_weight;
  foreach ($blocks as $block) {
    if (!($block = explode('|', $block))) {
      return FALSE;
    }
    $count = db_update('block')
      ->fields(['weight' => $weight])
      ->condition('module', $block[0])
      ->condition('delta', $block[1])
      ->execute();
    if (!$count) {
      return FALSE;
    }
    $weight += 1;
  }
}

//function _loft_dev_ga_options(&$options, $key = '') {
//  $allowed_array_keys = array('class');
//  $options = array_unique($options);
//  if (is_array($options)) {
//    foreach (array_keys($options) as $option_key) {
//      $value = current($options);
//      if (count($options) === 1 && !is_array($value)) {
//        $options = $value;
//      }
//      else {
//        _loft_dev_ga_options($options[$option_key], $option_key);
//      }
//    }
//  }
//}

/**
 * Get all the libraries by module
 */
function loft_dev_get_libraries() {
  $libraries = &drupal_static(__FUNCTION__, []);
  if (empty($libraries)) {
    $modules = module_list();
    foreach ($modules as $module) {
      if ($library = drupal_get_library($module)) {
        $libraries[$module] = $library;
      }
    }
    ksort($libraries);
  }

  return $libraries;
}

/**
 * Form builder for the loft_dev_node_access form.
 *
 * Generate the node access form
 *
 * @see     loft_dev_node_access_form_validate()
 * @see     loft_dev_node_access_form_submit()
 * @ingroup forms
 */
function loft_dev_node_access_form($form, &$form_state) {
  if (empty($_SESSION['loft_dev']['node_access'])) {
    $_SESSION['loft_dev']['node_access'] = [];
  }
  $default = $_SESSION['loft_dev']['node_access'];
  $has_settings = !empty($default);
  $default += [
    'nids' => [],
    'uids' => [],
  ];

  $form['settings'] = [
    '#type' => 'fieldset',
    '#title' => t('Loft Node Access Settings'),
    '#collapsible' => TRUE,
    '#collapsed' => $has_settings,
  ];
  $form['settings']['nids'] = [
    '#type' => 'textfield',
    '#description' => t('Comma separated list of nids'),
    '#title' => t('NIDs'),
    '#default_value' => implode(',', $default['nids']),
    '#required' => TRUE,
  ];
  $form['settings']['uids'] = [
    '#type' => 'textfield',
    '#description' => t('Comma separated list of uids or usernames'),
    '#title' => t('Users'),
    '#default_value' => implode(',', $default['uids']),
    '#required' => TRUE,
  ];
  $form['settings']['submit'] = [
    '#type' => 'submit',
    '#value' => t('Build Table'),
  ];

  $output = '';
  if ($default['nids'] && $default['uids']) {

    $nodes = \Drupal::entityManager()
      ->getStorage('node')
      ->loadMultiple($default['nids']);
    $accounts = [];
    foreach ($default['uids'] as $uid) {
      if (!is_numeric($uid)) {
        $temp = user_load_by_name($uid);
      }
      else {
        $temp = \Drupal::entityManager()->getStorage('user')->load($uid);
      }
      if ($temp) {
        $accounts[] = $temp;
      }
    }
    $accounts = array_filter($accounts);

    // Build the table
    foreach ($nodes as $node) {
      $caption = t('nid: @nid (type: @type) title: @title', [
        '@nid' => $node->nid,
        '@type' => $node->type,
        '@title' => $node->title,
      ]);
      $rows = [];
      foreach ($accounts as $account) {
        // @FIXME
        // theme() has been renamed to _theme() and should NEVER be called directly.
        // Calling _theme() directly can alter the expected output and potentially
        // introduce security issues (see https://www.drupal.org/node/2195739). You
        // should use renderable arrays instead.
        //
        //
        // @see https://www.drupal.org/node/2195739
        // $rows[] = [
        //           theme("username", ['account' => $account]),
        //           node_access('create', $node, $account) ? t('Yes') : '&ndash;',
        //           node_access('view', $node, $account) ? t('Yes') : '&ndash;',
        //           node_access('update', $node, $account) ? t('Yes') : '&ndash;',
        //           node_access('delete', $node, $account) ? t('Yes') : '&ndash;',
        //         ];

      }
      // @FIXME
      // theme() has been renamed to _theme() and should NEVER be called directly.
      // Calling _theme() directly can alter the expected output and potentially
      // introduce security issues (see https://www.drupal.org/node/2195739). You
      // should use renderable arrays instead.
      //
      //
      // @see https://www.drupal.org/node/2195739
      // $output .= theme("table", [
      //           'caption' => $caption,
      //           'header' => [
      //             t('User'),
      //             t('Create'),
      //             t('View'),
      //             t('Edit'),
      //             t('Delete'),
      //           ],
      //           'rows' => $rows,
      //         ]) . "\n";

    }
    if ($output) {
      $form['table'] = [
        '#markup' => $output,
      ];
    }
  }

  return $form;
}

/**
 * Form submission handler for loft_node_access_form().
 *
 * @see loft_node_access_form()
 * @see loft_node_access_form_validate()
 */
function loft_dev_node_access_form_submit($form, &$form_state) {
  $form_state['values']['nids'] = explode(',', $form_state['values']['nids']);
  $form_state['values']['uids'] = explode(',', $form_state['values']['uids']);
  $_SESSION['loft_dev']['node_access'] = $form_state['values'];
}

/**
 * Supplies information about a given authentication method to Services.
 *
 * @return
 *   An associative array with information about the authentication method
 *   and its callbacks. The possible keys are as follows (all keys are
 *   optional unless noted).
 *
 *   - title (required): The display name for this authentication method.
 *   - description (required): Longer text describing this authentciation
 *     method.
 *   - authenticate_call (required): The name of a function to be called
 *     to perform the actual authentication. <details of params/return>
 *   - security_settings: A callback function which returns an associative
 *     array of Form API elements for a settings form.
 *   - default_security_settings: A callback funtion which returns an array
 *     with the default settings for the auth module.
 *   - _services_security_settings_validate: The name of a standard form
 *     validation callback for the form defined in 'security_settings'.
 *   - _services_security_settings_submit: The name of a standard form
 *     submit callback for the form defined in 'security_settings'.
 *   - alter_controllers: The name of a callback function which will alter a
 *     services method signature in order to add required arguments.
 *   - controller_settings: A callback function which returns an associative
 *     array of Form API elements for a controller settings form.
 *   - file: An include file which contains the authentication callbacks.
 */
function loft_dev_services_authentication_info() {
  return [
    'title' => 'Loft Dev Preset User Auth',
    'description' => 'Can be used to pre-authentate a given user for all calls during development.',
    'authenticate_call' => '_loft_dev_services_authenticate_call',
    'security_settings' => '_loft_dev_services_auth_form',
  ];
}

/**
 * Authenticate a services call using the settings user.
 *
 * @param array $settings
 * @param string $method
 * @param array $args
 *
 * @return NULL||string
 */
function _loft_dev_services_authenticate_call() {
  $user = \Drupal::currentUser();
  list($settings) = func_get_args();

  $user = user_load_by_name($settings['username']);
  if (empty($user->uid)) {
    return services_error(t("The username @name does not exist. Can't authenticate.", [
      '@name' => $settings['username'],
    ]), 403);
  }
}

/**
 * Form builder for the _loft_dev_services_auth_form form.
 *
 * Settings for to define the uid of the user to use as authenticated.
 *
 * @param array $form
 * @param array &$form_state
 *
 * @ingroup forms
 */
function _loft_dev_services_auth_form($settings, &$form_state) {
  $form['username'] = [
    '#type' => 'textfield',
    '#description' => t('All server calls will authenticate with this user.'),
    '#title' => t('Username'),
    '#default_value' => empty($settings['username']) ? '' : $settings['username'],
    '#required' => TRUE,
    '#autocomplete_path' => 'user/autocomplete',
    '#maxlength' => 60,
  ];

  return $form;
}

/**
 * Implements hook_theme().
 */
function loft_dev_theme($existing, $type, $theme, $path) {
  return [
    'loft_dev_migration' => [
      'variables' => [
        'urls' => NULL,
        'results' => [],
      ],
      'file' => loft_dev_include('theme', 2),
    ],
    'loft_dev_css_circle' => [
      'variables' => [
        'width' => '8px',
        'color' => '#ffffff',
        'tag' => 'div',
        'attributes' => [],
      ],
      'file' => loft_dev_include('theme', 2),
    ],
  ];
}

/**
 * Implements hook_css_cache_alter().
 *
 * You must hack core to use this hook.  To do so add the following
 * line to the function shown.
 *
 * @code
 *   function drupal_build_css_cache($css) {
 *     drupal_alter('css_cache', $css);
 * @endcode
 */
function loft_dev_css_cache_alter(&$css) {
  // @FIXME
  // Could not extract the default value because it is either indeterminate, or
  // not scalar. You'll need to provide a default value in
  // config/install/loft_dev.settings.yml and config/schema/loft_dev.schema.yml.
  $omit = \Drupal::config('loft_dev.settings')->get('loft_dev_css_files_omit');
  // @FIXME
  // Could not extract the default value because it is either indeterminate, or
  // not scalar. You'll need to provide a default value in
  // config/install/loft_dev.settings.yml and config/schema/loft_dev.schema.yml.
  $css_files = \Drupal::config('loft_dev.settings')
    ->get('loft_dev_css_files_options');
  foreach ($css as $key => $data) {
    if ($data['type'] === 'file') {
      $css_files[$data['data']] = $data['data'];
      if (in_array($data['data'], $omit)) {
        unset($css[$key]);
      }
    }
  }
  \Drupal::configFactory()
    ->getEditable('loft_dev.settings')
    ->set('loft_dev_css_files_options', $css_files)
    ->save();
}

/**
 * Tries to return the page title of a path.
 *
 * @param string &$path
 *   $path may be modified as the normal path.
 *
 * @return string  If title can't be determined, $path is returned.
 */
function loft_dev_get_path_title(&$path) {
  if (\Drupal\Component\Utility\UrlHelper::isExternal($path)) {
    // @FIXME
    // url() expects a route name or an external URI.
    // $find = url('', ['absolute' => TRUE]);

    list($null, $path) = explode($find, $path);
  }
  $path = trim(trim($path), '/');
  $path = drupal_get_normal_path($path);

  // @FIXME
  // menu_get_item() has been removed. To retrieve route information, use the
  // RouteMatch object, which you can retrieve by calling \Drupal::routeMatch().
  //
  //
  // @see https://www.drupal.org/node/2203305
  // $item = menu_get_item($path);


  return isset($item['title']) ? $item['title'] : $path;
}

/**
 * Form builder for the loft_dev_button_catalog_form form.
 *
 * Populate the button catalog settings.
 *
 * @param array $form
 * @param array &$form_state
 *
 * @see     loft_dev_button_catalog_form_validate()
 * @see     loft_dev_button_catalog_form_submit()
 * @ingroup forms
 */
function loft_dev_button_catalog_form($form, &$form_state, ButtonCatalog $catalog) {

  $form['advanced'] = [
    '#type' => 'container',
    '#title' => t('Advanced'),
    '#collapsible' => TRUE,
    '#collapsed' => TRUE,
  ];
  $form['advanced']['title'] = [
    '#type' => 'textfield',
    '#title' => t('Title'),
    '#default_value' => $catalog->getTitle(),
    '#required' => TRUE,
  ];
  $form['advanced']['class'] = [
    '#type' => 'textfield',
    '#title' => t('CSS class .button'),
    '#default_value' => '',
    '#required' => TRUE,
  ];
  $form['advanced']['state'] = [
    '#type' => 'select',
    '#title' => t('State'),
    '#default_value' => '',
    '#options' => [NULL => ''] + array_combine($catalog->getStates(), $catalog->getStates()),
  ];
  $form['advanced']['layout'] = [
    '#type' => 'select',
    '#title' => t('Layout'),
    '#default_value' => '',
    '#options' => [NULL => ''] + array_combine($catalog->getLayouts(), $catalog->getLayouts()),
  ];
  //    $form['advanced']['actions']['update'] = array(
  //        '#type'  => 'submit',
  //        '#value' => t('Update'),
  //    );

  return $form;
}

/**
 * Implements hook_loft_deploy_border_access().
 */
function loft_dev_loft_deploy_border_access_alter(&$access) {
  global $_design_guide;
  if ($_design_guide) {

    // Suppress loft_deploy border on design guide page.
    $access = FALSE;
  }
}

/**
 * Generate PHPTemplate template file stub.
 *
 * Place the following at the top of any php file and load the page.  The
 * content should change and you should see a file header in it's place.
 *
 * @code
 * <?php
 * loft_dev_file_header(__FILE__, get_defined_vars());
 * @endcode
 *
 * @param string $template_file
 * @param array $vars
 *
 * @throws \InvalidArgumentException If the filename is misnamed.
 * @throws \RuntimeException If the file cannot be written.
 */
function loft_dev_file_header($template_file, array $vars) {
  $contents = file_get_contents($template_file);
  $contents = preg_replace('/^\s*<\?php/', '', $contents);
  $contents = preg_replace('/\s*loft_dev_file_header\(.+$/m', '', $contents);
  $stub = rtrim(_loft_dev_file_header(__FUNCTION__, $template_file, $vars));
  $stub .= PHP_EOL . PHP_EOL . ltrim($contents);
  if (!file_put_contents($template_file, $stub)) {
    throw new \RuntimeException("Could not write file.");
  }
}

function _loft_dev_file_header_handle_vars($options, $vars, &$comments, &$level = 0) {
  $vars_as_array = json_decode(json_encode($vars), TRUE);
  $func = __FUNCTION__;
  ++$level;
  $prefix = ' *' . str_repeat(' ', $level * $options['tab_spaces']) . '- ';
  foreach ($vars_as_array as $varname => $var) {
    if (is_numeric($varname)) {
      continue;
    }
    $var_prefix = isset($options['var_prefix'][$level]) ? $options['var_prefix'][$level] : $options['var_prefix'][0];
    $var_suffix = isset($options['var_suffix'][$level]) ? $options['var_suffix'][$level] : $options['var_suffix'][0];

    $type = gettype($vars[$varname]);
    if ($type === 'object') {
      $type = '\\' . get_class($vars[$varname]);
    }

    $comments[] = $prefix . $var_prefix . $varname . $var_suffix . ' ' . $type;
    if ($level < $options['max_depth'] && (is_array($var))) {
      $func($options, $var, $comments, $level);
    }
  }
  --$level;
}

/**
 * Helper function to generate a file header.
 *
 * @see loft_dev_twig_hook_stub
 * @see loft_dev_file_header
 */
function _loft_dev_file_header($parent, $template_file, array $vars, $prepend_dollar_sign = TRUE) {
  $filename = preg_replace('/\.(html|tpl)$/', '', pathinfo($template_file, PATHINFO_FILENAME));

  // TODO Add this back when we have access to this class.
  //  $filename = Grammar::titleCase(str_replace('--', ', ', $filename));
  if (preg_match('/(twig|tpl\.php)$/', $template_file, $matches)) {
    $extension = $matches[1];
  }
  else {
    $extension = pathinfo($template_file, PATHINFO_EXTENSION);
  }
  $type = NULL;
  switch ($extension) {
    case 'tpl.php':
      $type = 'php';
    case 'twig':
      $type = $type ? $type : 'twig';
      $implementation = 'Theme Implementation';
      break;

    case 'inc':
      $type = 'php';
      $implementation = 'Alter Partial';
      break;
  }
  ksort($vars);

  $comments = [];
  _loft_dev_file_header_handle_vars([
    'tab_spaces' => 4,
    'var_prefix' => [0 => '', 1 => ($prepend_dollar_sign ? '$' : '')],
    'var_suffix' => [0 => '', 1 => ''],
    'max_depth' => 2,
  ], $vars, $comments);

  $list = implode(PHP_EOL, $comments);
  $phpcs = '';
  if ($type === 'php') {
    $phpcs = PHP_EOL . ' *' . PHP_EOL . ' * phpcs:disable Generic.PHP.DisallowShortOpenTag';
  }

  $stub = <<<EOD
<?php

/**
 * @file
 * {$implementation} for {$filename}.
 *
 * Available variables:
{$list}.{$phpcs}
 */
EOD;
  $context = [
    'template_file' => $template_file,
    'parent' => $parent,
  ];
  \Drupal::moduleHandler()->alter('loft_dev_file_header', $stub, $context);

  return $stub;
}

function loft_dev_twiggy_twig_alter(Twig_Environment $twig) {
  $twig->addFunction();
}

function loft_dev_loft_core_suppress_messages() {
  return [
    'warning' => [
      '/^Internet Explorer <=7 which will not load more than/',
    ],
  ];
}

/**
 * Implements hook_js_alter().
 */
function loft_dev_js_alter(&$js) {
  $switches = array_fill_keys([
    'external',
    'file.contrib',
    'file.core',
    'file.custom',
    'file.theme',
    'inline',
    'setting',
  ], TRUE);
  \Drupal::moduleHandler()->alter('loft_dev_js', $switches);
  $js = array_filter($js, function ($item) use ($switches) {
    if ($item['type'] !== 'file') {
      return $switches[$item['type']];
    }

    $filetype = NULL;
    if (strpos($item['data'], 'theme') !== FALSE) {
      $filetype = 'theme';
    }
    elseif (strpos($item['data'], '/modules') !== FALSE) {
      if (strpos($item['data'], '/custom') !== FALSE) {
        $filetype = 'custom';
      }
      else {
        $filetype = 'contrib';
      }
    }
    elseif (strpos($item['data'], 'misc/') !== FALSE) {
      $filetype = 'core';
    }

    return isset($switches['file.' . $filetype]) ? $switches['file.' . $filetype] : TRUE;
  });
}

/**
 * Implements hook_usage_cron().
 */
function loft_dev_usage_cron() {
  try {
    $backups_enabled = \Drupal::config('loft_dev.settings')
      ->get('usage_cron_backups');
    if (!$backups_enabled) {
      return;
    }

    // Look at the result of the last backup for the presence of the word
    // "failed" in the output.  It's not possible yet to capture the exit status
    // of the async command, so we have to check for the word "failed" in the
    // output instead.
    $previous = \Drupal::state()->get('loft_dev_usage_cron_result');
    \Drupal::state()->delete('loft_dev_usage_cron_result');
    if ($previous) {
      if (($output = $previous->getOutput()) && stristr($output, 'failed') !== FALSE) {
        \Drupal::messenger()
          ->addError(sprintf("Previous usage cron failed to perform a local website backup. %s", $output));
      }
      $previous->flush();
    }

    // Send off an async request to backup the DB.  The status will be checked
    // on the next usage cron and if it has failed it will be reported as a
    // message.
    $result = Bash::exec([
      'cd /app && ./bin/website_backup backup -d --local=/app/private/default/db/purgeable --latest',
    ], [], TRUE);
    \Drupal::state()->set('loft_dev_usage_cron_result', $result);
    \Drupal::messenger()
      ->addMessage("Usage cron has successfully performed a local database-only backup.");
  }
  catch (\Exception $exception) {
    \Drupal::state()->delete('loft_dev_usage_cron_result');
    \Drupal::messenger()
      ->addError(sprintf("Usage cron failed to perform a local website backup. %s", $exception->getMessage()));
  }
}
